<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pvl_singlediode &mdash; PV LIB 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="PV LIB 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">PV LIB 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pvl_singlediode</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pvl_tools</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy</span> 
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">lambertw</span>
<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">pvl_singlediode</span><span class="p">(</span><span class="n">Module</span><span class="p">,</span><span class="n">IL</span><span class="p">,</span><span class="n">I0</span><span class="p">,</span><span class="n">Rs</span><span class="p">,</span><span class="n">Rsh</span><span class="p">,</span><span class="n">nNsVth</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<div class="viewcode-block" id="pvl_singlediode"><a class="viewcode-back" href="../stubs/pvl_singlediode.pvl_singlediode.html#pvl_singlediode.pvl_singlediode">[docs]</a><span class="sd">    Solve the single-diode model to obtain a photovoltaic IV curve</span>


<span class="sd">    pvl_singlediode solves the single diode equation [1]:</span>
<span class="sd">    I = IL - I0*[exp((V+I*Rs)/(nNsVth))-1] - (V + I*Rs)/Rsh</span>
<span class="sd">    for I and V when given IL, I0, Rs, Rsh, and nNsVth (nNsVth = n*Ns*Vth) which</span>
<span class="sd">    are described later. pvl_singlediode returns a struct which contains</span>
<span class="sd">    the 5 points on the I-V curve specified in SAND2004-3535 [3]. </span>
<span class="sd">    If all IL, I0, Rs, Rsh, and nNsVth are scalar, a single curve</span>
<span class="sd">    will be returned, if any are DataFrames (of the same length), multiple IV</span>
<span class="sd">    curves will be calculated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    These imput parameters can be calculated using PVL_CALCPARAMS_DESOTO from </span>
<span class="sd">    meterological data. </span>

<span class="sd">    IL : float or DataFrame</span>
<span class="sd">                Light-generated current (photocurrent) in amperes under desired IV</span>
<span class="sd">                curve conditions. </span>

<span class="sd">    I0 : float or DataFrame</span>
<span class="sd">                Diode saturation current in amperes under desired IV curve</span>
<span class="sd">                conditions. </span>

<span class="sd">    Rs : float or DataFrame</span>
<span class="sd">                Series resistance in ohms under desired IV curve conditions. </span>

<span class="sd">    Rsh : float or DataFrame</span>
<span class="sd">                Shunt resistance in ohms under desired IV curve conditions. May</span>
<span class="sd">                be a scalar or DataFrame, but DataFrames must be of same length as all</span>
<span class="sd">                other input DataFrames.</span>

<span class="sd">    nNsVth : float or DataFrame</span>
<span class="sd">                the product of three components. 1) The usual diode ideal </span>
<span class="sd">                factor (n), 2) the number of cells in series (Ns), and 3) the cell </span>
<span class="sd">                thermal voltage under the desired IV curve conditions (Vth).</span>
<span class="sd">                The thermal voltage of the cell (in volts) may be calculated as </span>
<span class="sd">                k*Tcell/q, where k is Boltzmann&#39;s constant (J/K), Tcell is the</span>
<span class="sd">                temperature of the p-n junction in Kelvin, and q is the elementary </span>
<span class="sd">                charge of an electron (coulombs). </span>
<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>

<span class="sd">    NumPoints : integer</span>

<span class="sd">                Number of points in the desired IV curve (optional). Must be a finite </span>
<span class="sd">                scalar value. Non-integer values will be rounded to the next highest</span>
<span class="sd">                integer (ceil). If ceil(NumPoints) is &lt; 2, no IV curves will be produced</span>
<span class="sd">                (i.e. Result.V and Result.I will not be generated). The default</span>
<span class="sd">                value is 0, resulting in no calculation of IV points other than</span>
<span class="sd">                those specified in [3].</span>

<span class="sd">    Returns</span>

<span class="sd">    Result : DataFrame</span>

<span class="sd">                A DataFrame with the following fields. All fields have the</span>
<span class="sd">                same number of rows as the largest input DataFrame:</span>
<span class="sd">                </span>
<span class="sd">                * Result.Isc -  short circuit current in amperes.</span>
<span class="sd">                * Result.Voc -  open circuit voltage in volts.</span>
<span class="sd">                * Result.Imp -  current at maximum power point in amperes. </span>
<span class="sd">                * Result.Vmp -  voltage at maximum power point in volts.</span>
<span class="sd">                * Result.Pmp -  power at maximum power point in watts.</span>
<span class="sd">                * Result.Ix -  current, in amperes, at V = 0.5*Voc.</span>
<span class="sd">                * Result.Ixx -  current, in amperes, at V = 0.5*(Voc+Vmp).</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    The solution employed to solve the implicit diode equation utilizes</span>
<span class="sd">    the Lambert W function to obtain an explicit function of V=f(i) and</span>
<span class="sd">    I=f(V) as shown in [2].</span>

<span class="sd">    References</span>
<span class="sd">    -----------</span>

<span class="sd">    [1] S.R. Wenham, M.A. Green, M.E. Watt, &quot;Applied Photovoltaics&quot; </span>
<span class="sd">    ISBN 0 86758 909 4</span>

<span class="sd">    [2] A. Jain, A. Kapoor, &quot;Exact analytical solutions of the parameters of </span>
<span class="sd">    real solar cells using Lambert W-function&quot;, Solar Energy Materials </span>
<span class="sd">    and Solar Cells, 81 (2004) 269-277.</span>

<span class="sd">    [3] D. King et al, &quot;Sandia Photovoltaic Array Performance Model&quot;,</span>
<span class="sd">    SAND2004-3535, Sandia National Laboratories, Albuquerque, NM</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    pvl_sapm</span>
<span class="sd">    pvl_calcparams_desoto</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">Vars</span><span class="o">=</span><span class="nb">locals</span><span class="p">()</span>
    <span class="n">Expect</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Module&#39;</span><span class="p">:(</span><span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="s">&#39;IL&#39;</span><span class="p">:(</span><span class="s">&#39;x&gt;0&#39;</span><span class="p">),</span>
            <span class="s">&#39;I0&#39;</span><span class="p">:(</span><span class="s">&#39;x&gt;0&#39;</span><span class="p">),</span>
            <span class="s">&#39;Rs&#39;</span><span class="p">:(</span><span class="s">&#39;x&gt;0&#39;</span><span class="p">),</span>
            <span class="s">&#39;Rsh&#39;</span><span class="p">:(</span><span class="s">&#39;x&gt;0&#39;</span><span class="p">),</span>
            <span class="s">&#39;nNsVth&#39;</span><span class="p">:(</span><span class="s">&#39;x&gt;0&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">var</span><span class="o">=</span><span class="n">pvl_tools</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">Vars</span><span class="p">,</span><span class="n">Expect</span><span class="p">)</span>

    <span class="c"># Find Isc using Lambert W</span>
    <span class="n">Isc</span> <span class="o">=</span> <span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="p">,</span> <span class="n">Rs</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rs</span><span class="p">,</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">nNsVth</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">I0</span><span class="p">,</span> <span class="n">IL</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">IL</span><span class="p">)</span>


    <span class="c">#If passed a dataframe, output a dataframe, if passed a list or scalar,</span>
    <span class="c">#return a dict </span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="n">DFOut</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">&#39;Isc&#39;</span><span class="p">:</span><span class="n">Isc</span><span class="p">})</span>
        <span class="n">DFOut</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="o">.</span><span class="n">index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DFOut</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Isc&#39;</span><span class="p">:</span><span class="n">Isc</span><span class="p">}</span>


    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Rsh&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Rs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rs</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;nNsVth&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">nNsVth</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;I0&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">I0</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;IL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">IL</span>

    <span class="n">__</span><span class="p">,</span><span class="n">Voc_return</span> <span class="o">=</span> <span class="n">golden_sect_DataFrame</span><span class="p">(</span><span class="n">DFOut</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">Module</span><span class="o">.</span><span class="n">V_oc_ref</span><span class="o">*</span><span class="mf">1.6</span><span class="p">,</span><span class="n">Voc_optfcn</span><span class="p">)</span>
    <span class="n">Voc</span><span class="o">=</span><span class="n">Voc_return</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c">#create an immutable copy </span>

    <span class="n">Pmp</span><span class="p">,</span><span class="n">Vmax</span> <span class="o">=</span> <span class="n">golden_sect_DataFrame</span><span class="p">(</span><span class="n">DFOut</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">var</span><span class="o">.</span><span class="n">Module</span><span class="o">.</span><span class="n">V_oc_ref</span><span class="o">*</span><span class="mf">1.14</span><span class="p">,</span><span class="n">pwr_optfcn</span><span class="p">)</span>
    <span class="n">Imax</span> <span class="o">=</span> <span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="p">,</span> <span class="n">Rs</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rs</span><span class="p">,</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">nNsVth</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">Vmax</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">I0</span><span class="p">,</span> <span class="n">IL</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">IL</span><span class="p">)</span>
    <span class="c"># Invert the Power-Current curve. Find the current where the inverted power</span>
    <span class="c"># is minimized. This is Imax. Start the optimization at Voc/2</span>

    <span class="c"># Find Ix and Ixx using Lambert W</span>
    <span class="n">Ix</span> <span class="o">=</span> <span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="p">,</span> <span class="n">Rs</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rs</span><span class="p">,</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">nNsVth</span><span class="p">,</span> <span class="n">V</span><span class="o">=.</span><span class="mi">5</span><span class="o">*</span><span class="n">Voc</span><span class="p">,</span> <span class="n">I0</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">I0</span><span class="p">,</span> <span class="n">IL</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">IL</span><span class="p">)</span>
    <span class="n">Ixx</span> <span class="o">=</span> <span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rsh</span><span class="p">,</span> <span class="n">Rs</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">Rs</span><span class="p">,</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">nNsVth</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Voc</span><span class="o">+</span><span class="n">Vmax</span><span class="p">),</span> <span class="n">I0</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">I0</span><span class="p">,</span> <span class="n">IL</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">IL</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # If the user says they want a curve of with number of points equal to</span>
<span class="sd">    # NumPoints (must be &gt;=2), then create a voltage array where voltage is</span>
<span class="sd">    # zero in the first column, and Voc in the last column. Number of columns</span>
<span class="sd">    # must equal NumPoints. Each row represents the voltage for one IV curve.</span>
<span class="sd">    # Then create a current array where current is Isc in the first column, and</span>
<span class="sd">    # zero in the last column, and each row represents the current in one IV</span>
<span class="sd">    # curve. Thus the nth (V,I) point of curve m would be found as follows:</span>
<span class="sd">    # (Result.V(m,n),Result.I(m,n)).</span>
<span class="sd">    if NumPoints &gt;= 2</span>
<span class="sd">       s = ones(1,NumPoints); # shaping DataFrame to shape the column DataFrame parameters into 2-D matrices</span>
<span class="sd">       Result.V = (Voc)*(0:1/(NumPoints-1):1);</span>
<span class="sd">       Result.I = I_from_V(Rsh*s, Rs*s, nNsVth*s, Result.V, I0*s, IL*s);</span>
<span class="sd">    end</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Imp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Imax</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Voc&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Voc</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Vmp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Vmax</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Pmp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Pmp</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Ix&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Ix</span>
    <span class="n">DFOut</span><span class="p">[</span><span class="s">&#39;Ixx&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Ixx</span>

    <span class="k">return</span>  <span class="n">DFOut</span>



<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created April,2014</span></div>
<span class="sd">Author: Rob Andrews, Calama Consulting</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">golden_sect_DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">VL</span><span class="p">,</span><span class="n">VH</span><span class="p">,</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Vectorized golden section search for finding MPPT from a dataframe timeseries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    df : DataFrame</span>

<span class="sd">            Dataframe containing a timeseries of inputs to the function to be optimized.</span>
<span class="sd">            Each row should represent an independant optimization</span>

<span class="sd">    VL: float</span>
<span class="sd">            low bound of the optimization</span>

<span class="sd">    VH: float</span>
<span class="sd">            Uppoer bound of the optimization</span>

<span class="sd">    func: function</span>
<span class="sd">            function to be optimized must be in the form f(dataframe,x)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    func(df,&#39;V1&#39;) : DataFrame</span>
<span class="sd">            function evaluated at the optimal point</span>

<span class="sd">    df[&#39;V1&#39;]: Dataframe</span>
<span class="sd">            Dataframe of optimal points</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    This funtion will find the MAXIMUM of a function</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">VH</span>
    <span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">VL</span>

    <span class="n">err</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">]</span>
    <span class="n">errflag</span><span class="o">=</span><span class="bp">True</span>
    <span class="n">iterations</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">errflag</span><span class="p">:</span>

        <span class="n">phi</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;V1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">phi</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;V2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">phi</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;f1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s">&#39;V1&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;f2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">func</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s">&#39;V2&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;SW_Flag&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;f1&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;f2&#39;</span><span class="p">]</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;V2&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;SW_Flag&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VL&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;SW_Flag&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;V1&#39;</span><span class="p">]</span><span class="o">*~</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;SW_Flag&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;VH&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;SW_Flag&#39;</span><span class="p">])</span>
        
        <span class="n">err</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;V1&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;V2&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">errflag</span><span class="o">=</span><span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">&gt;.</span><span class="mo">01</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errflag</span><span class="o">=</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">&gt;.</span><span class="mo">01</span><span class="p">)</span>

        <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&gt;</span><span class="mi">50</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;EXCEPTION:iterations exeeded maximum (50)&quot;</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="s">&#39;V1&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s">&#39;V1&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">pwr_optfcn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">loc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    function to find power from I_from_V</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">I</span><span class="o">=</span><span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;Rsh&#39;</span><span class="p">],</span><span class="n">Rs</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;Rs&#39;</span><span class="p">],</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;nNsVth&#39;</span><span class="p">],</span> <span class="n">V</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span> <span class="n">I0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;I0&#39;</span><span class="p">],</span> <span class="n">IL</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;IL&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">Voc_optfcn</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">loc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    function to find V_oc from I_from_V</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">I</span><span class="o">=-</span><span class="nb">abs</span><span class="p">(</span><span class="n">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;Rsh&#39;</span><span class="p">],</span> <span class="n">Rs</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;Rs&#39;</span><span class="p">],</span> <span class="n">nNsVth</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;nNsVth&#39;</span><span class="p">],</span> <span class="n">V</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">loc</span><span class="p">],</span> <span class="n">I0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;I0&#39;</span><span class="p">],</span> <span class="n">IL</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">&#39;IL&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span> <span class="nf">I_from_V</span><span class="p">(</span><span class="n">Rsh</span><span class="p">,</span> <span class="n">Rs</span><span class="p">,</span> <span class="n">nNsVth</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">IL</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    # calculates I from V per Eq 2 Jain and Kapoor 2004</span>
<span class="sd">    # uses Lambert W implemented in wapr_vec.m</span>
<span class="sd">    # Rsh, nVth, V, I0, IL can all be DataFrames</span>
<span class="sd">    # Rs can be a DataFrame, but should be a scalar</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">argW</span> <span class="o">=</span> <span class="n">Rs</span><span class="o">*</span><span class="n">I0</span><span class="o">*</span><span class="n">Rsh</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Rsh</span><span class="o">*</span><span class="p">(</span><span class="n">Rs</span><span class="o">*</span><span class="p">(</span><span class="n">IL</span><span class="o">+</span><span class="n">I0</span><span class="p">)</span><span class="o">+</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nNsVth</span><span class="o">*</span><span class="p">(</span><span class="n">Rs</span><span class="o">+</span><span class="n">Rsh</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="n">nNsVth</span><span class="o">*</span><span class="p">(</span><span class="n">Rs</span> <span class="o">+</span> <span class="n">Rsh</span><span class="p">))</span>
    <span class="n">inputterm</span> <span class="o">=</span><span class="n">lambertw</span><span class="p">(</span><span class="n">argW</span><span class="p">)</span>

    <span class="c"># Eqn. 4 in Jain and Kapoor, 2004</span>
    <span class="n">I</span> <span class="o">=</span> <span class="o">-</span><span class="n">V</span><span class="o">/</span><span class="p">(</span><span class="n">Rs</span> <span class="o">+</span> <span class="n">Rsh</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">nNsVth</span><span class="o">/</span><span class="n">Rs</span><span class="p">)</span> <span class="o">*</span> <span class="n">inputterm</span> <span class="o">+</span> <span class="n">Rsh</span><span class="o">*</span><span class="p">(</span><span class="n">IL</span> <span class="o">+</span> <span class="n">I0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Rs</span> <span class="o">+</span> <span class="n">Rsh</span><span class="p">)</span>
    

    <span class="k">return</span> <span class="n">I</span><span class="o">.</span><span class="n">real</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">PV LIB 1.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Sandia National Labs.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>